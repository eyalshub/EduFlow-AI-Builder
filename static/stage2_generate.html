<!DOCTYPE html>
<html lang="he">
<head>
    <meta charset="UTF-8">
    <title>âœï¸ ×©×œ×‘ 2 â€“ ×¢×¨×™×›×ª ×˜×§×¡×˜×™× ×•×™×¦×™×¨×ª ×©××œ×•×ª</title>
    <style>
        body {
            font-family: 'Segoe UI', sans-serif;
            margin: 0 auto;
            max-width: 700px;
            padding: 2rem;
            background-color: #f9f9fb;
            color: #333;
            direction: rtl;
        }
        h1 {
            text-align: center;
            color: #2a2a2a;
            margin-bottom: 2rem;
        }
        label {
            font-weight: bold;
            margin-top: 1rem;
            display: block;
        }
        input, select, textarea {
            width: 100%;
            padding: 0.6rem;
            margin-top: 0.3rem;
            border: 1px solid #ccc;
            border-radius: 5px;
            box-sizing: border-box;
        }
        textarea {
            min-height: 100px;
        }
        button {
            margin-top: 1.5rem;
            padding: 0.8rem 1.5rem;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 1rem;
            cursor: pointer;
        }
        .result-box {
            margin-top: 2rem;
            padding: 1rem;
            background-color: #fff;
            border: 1px solid #ccc;
            border-radius: 8px;
            direction: ltr;
        }
    </style>
</head>
<body>

<h1>âœï¸ ×©×œ×‘ 2 â€“ ×¢×¨×™×›×ª ×˜×§×¡×˜×™× ××• ×™×¦×™×¨×ª ×©××œ×•×ª</h1>

<form id="stage2Form">
    <label>× ×•×©×</label>
    <input type="text" name="topicName" required>

    <label>××§×¦×•×¢</label>
    <input type="text" name="subject" required>

    <label>×©×›×‘×ª ×’×™×œ</label>
    <input type="text" name="gradeLevel" required>

    <label>×¨×¢×™×•×Ÿ ××¨×›×–×™</label>
    <input type="text" name="bigIdea">

    <label>×©×¢×¨ ×œ××™×“×”</label>
    <input type="text" name="learningGate">

    <label>××™×•×× ×•×™×•×ª (××•×¤×¨×“×•×ª ×‘×¤×¡×™×§×™×)</label>
    <input type="text" name="skills">

    <label>××™×•×× ×•×™×•×ª ××™×•×©×¨×•×ª (comma ××• ×©×•×¨×” ×—×“×©×”)</label>
    <textarea name="alignments"></textarea>

    <label>×˜×•×•×— ×™×¦×™×¨×” (generationScope)</label>
    <select name="generationScope" required>
        <option value="Single Topic">×™×—×™×“</option>
        <option value="Course Scope">×§×•×¨×¡ ××œ×</option>
    </select>

    <label>×˜×§×¡×˜ ×—×•×¤×©×™ ×œ×¤×¨×•××¤×˜ (××•×¤×¦×™×•× ×œ×™)</label>
    <textarea name="freePrompt"></textarea>

    <label>×”×§×©×¨ ×œ×™××•×“×™ (××•×¤×¦×™×•× ×œ×™)</label>
    <textarea name="context"></textarea>

    <label>×˜×§×¡×˜ ××§×•×¨ (chunk)</label>
    <textarea name="chunkText" required></textarea>

    <label>×¡×•×’ ×¤×¢×•×œ×”</label>
    <select name="mode">
        <option value="edit_text">ğŸ“ ×¢×¨×™×›×ª ×˜×§×¡×˜</option>
        <option value="generate_questions">â“ ×™×¦×™×¨×ª ×©××œ×•×ª</option>
    </select>

    <div id="questionOptions" style="display: none;">
        <label>×¡×•×’ ×©××œ×”</label>
        <select name="questionType">
            <option value="mcq">×‘×¨×™×¨×”</option>
            <option value="open">×¤×ª×•×—×”</option>
            <option value="matching">×”×ª×××”</option>
        </select>

        <label>×¨××ª ×—×©×™×‘×” (Bloom)</label>
        <select name="bloomLevel">
            <option value="knowledge">×™×“×¢</option>
            <option value="comprehension_application">×”×‘× ×” / ×™×™×©×•×</option>
            <option value="inference_evaluation">×”×¡×§×” / ×”×¢×¨×›×”</option>
        </select>

        <label>×¨××ª ×§×•×©×™</label>
        <select name="difficulty">
            <option value="easy">×§×œ</option>
            <option value="medium">×‘×™× ×•× ×™</option>
            <option value="hard">×§×©×”</option>
        </select>

        <label>×›××” ×©××œ×•×ª ×œ×™×™×¦×¨?</label>
        <input type="number" name="numQuestions" value="1" min="1" max="10">
    </div>

    <label>
        <input type="checkbox" name="saveToBlocks"> ğŸ’¾ ×©××•×¨ ×œ××¡×“ ×”× ×ª×•× ×™×
    </label>

    <button type="submit">ğŸš€ ×”×¤×¢×œ ×©×œ×‘ 2</button>
</form>

<div id="result" class="result-box" style="display: none;"></div>

<script>
    const form = document.getElementById("stage2Form");
    const modeSelect = form.mode;
    const questionOptions = document.getElementById("questionOptions");
    const resultBox = document.getElementById("result");

    modeSelect.addEventListener("change", () => {
        questionOptions.style.display = modeSelect.value === "generate_questions" ? "block" : "none";
    });

    form.addEventListener("submit", async (e) => {
        e.preventDefault();

        const data = {
            topicName: form.topicName.value,
            subject: form.subject.value,
            gradeLevel: form.gradeLevel.value,
            bigIdea: form.bigIdea.value || null,
            generationScope: form.generationScope.value,
            learningGate: form.learningGate.value || null,
            skills: form.skills.value
                ? form.skills.value.split(",").map(s => s.trim()).filter(Boolean)
                : [],
            alignments: form.alignments.value
                ? form.alignments.value.split(/\n|,/).map(s => s.trim()).filter(Boolean)
                : [],
            context: form.context.value || null,
            freePrompt: form.freePrompt.value || null,
            mode: form.mode.value,
            text: form.chunkText.value,
            chunks: [{
                chunk_id: "user_chunk_1",
                text: form.chunkText.value
            }],
            save_to_blocks: form.saveToBlocks.checked
        };

        if (form.mode.value === "generate_questions") {
            data.question_types = [form.questionType.value];
            data.cognitive_target = form.bloomLevel.value;
            data.target_difficulty = form.difficulty.value;
            data.num_questions = parseInt(form.numQuestions.value);
        }

        try {
            const response = await fetch("/api/v1/stage2/run", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(data)
            });

            const result = await response.json();
            resultBox.style.display = "block";

            if (response.ok) {
                resultBox.innerHTML = `<strong>âœ… ×¤×œ×˜ ×©×”×ª×§×‘×œ:</strong><pre>${JSON.stringify(result, null, 2)}</pre>`;
            } else {
                resultBox.innerHTML = `<span style="color:red;">âŒ ×©×’×™××”: ${result.detail || "×œ× ×™×“×•×¢×”"}</span>`;
            }

        } catch (err) {
            resultBox.style.display = "block";
            resultBox.innerHTML = `<span style="color:red;">âŒ ×©×’×™××ª ×¨×©×ª: ${err.message}</span>`;
        }
    });
</script>

</body>
</html>
