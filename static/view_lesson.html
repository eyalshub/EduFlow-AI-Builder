<!DOCTYPE html>
<html lang="he">
<head>
  <meta charset="UTF-8">
  <title>ğŸ“˜ ×ª×¦×•×’×ª ×§×•×¨×¡ â€“ Amit AI</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      margin: 2rem auto;
      max-width: 900px;
      padding: 2rem;
      background-color: #f4f7fa;
      color: #333;
      direction: rtl;
    }
    h1, h2, h3 { color: #1a1a1a; }
    .section, .toc, .summary {
      margin-bottom: 2rem;
      padding: 1rem;
      background-color: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.05);
    }
    ul { padding-right: 1.5rem; }
    li { margin-bottom: 0.5rem; }
    pre { white-space: pre-wrap; line-height: 1.6; }
    .toc h2, .summary h2 { margin-top: 0; }
    .toc ul {
      list-style: none;
      padding-right: 0;
    }
    .toc li a {
      text-decoration: none;
      color: #0077cc;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <h1>ğŸ“˜ ×ª×¦×•×’×ª ×§×•×¨×¡</h1>
  <div id="lesson"></div>

  <script>
    async function loadLesson() {
      const params = new URLSearchParams(window.location.search);
      const corpusId = params.get('corpusId');
      if (!corpusId) return document.getElementById('lesson').innerText = 'âŒ ××–×”×” ×§×•×¨×¡ ×œ× × ××¦×';

      try {
        const res = await fetch(`/api/v1/content-corpus/${corpusId}`);
        const contentType = res.headers.get("content-type");
        if (!contentType || !contentType.includes("application/json")) {
          throw new Error("Invalid JSON response");
        }

        const data = await res.json();
        const content = data.content || {};
        const container = document.getElementById('lesson');
        container.innerHTML = '';

        // âœ… ×ª×§×¦×™×¨
        if (content.finalSummary) {
          const summary = document.createElement('div');
          summary.className = 'summary';
          summary.innerHTML = `
            <h2>ğŸ” ×ª×§×¦×™×¨:</h2>
            <p>${content.finalSummary}</p>
          `;
          container.appendChild(summary);
        }

        const lessons = content.lessons || [];

        if (lessons.length > 0) {
          // âœ… ×˜×‘×œ×ª ×ª×•×›×Ÿ
          const toc = document.createElement('div');
          toc.className = 'toc';
          toc.innerHTML = `
            <h2>ğŸ§­ ×©×™×¢×•×¨×™×:</h2>
            <ul>
              ${lessons.map((lesson, idx) =>
                `<li><a href="#lesson-${idx + 1}">${idx + 1}. ${lesson.lessonTitle || '×œ×œ× ×›×•×ª×¨×ª'}</a></li>`
              ).join('')}
            </ul>
          `;
          container.appendChild(toc);

          // âœ… ×ª×•×›×Ÿ ×©×™×¢×•×¨×™×
          lessons.forEach((lesson, idx) => {
            const div = document.createElement('div');
            div.className = 'section';
            div.id = `lesson-${idx + 1}`;
            div.innerHTML = `
              <h2>ğŸ§© ×©×™×¢×•×¨ ${lesson.lessonIndex || idx + 1}: ${lesson.lessonTitle || '×œ×œ× ×›×•×ª×¨×ª'}</h2>

              <h3>ğŸ“¥ ××‘×•×</h3>
              <pre><strong>${lesson.introduction?.title || ''}</strong>\n${lesson.introduction?.paragraph || ''}</pre>

              <h3>ğŸ“š ×¤×¡×§××•×ª ×¢×™×§×¨×™×•×ª</h3>
              ${lesson.coreParagraphs?.map(p => `
                <div>
                  <strong>${p.title}</strong>
                  <pre>${p.paragraph}</pre>
                </div>
              `).join('') || '<pre>××™×Ÿ</pre>'}

              <h3>ğŸ“Œ ×¡×™×›×•×</h3>
              <pre><strong>${lesson.summary?.title || ''}</strong>\n${lesson.summary?.paragraph || ''}</pre>

              <h3>ğŸ—£ï¸ ×©××œ×•×ª ×œ×“×™×•×Ÿ</h3>
              <ul>
                ${(lesson.discussionQuestions || []).map(q => `<li>${q}</li>`).join('') || '<li>××™×Ÿ</li>'}
              </ul>
            `;
            container.appendChild(div);
          });

        } else {
          // âŒ ××™×Ÿ ×©×™×¢×•×¨×™×
          const msg = document.createElement('div');
          msg.className = 'section';
          msg.innerHTML = `<p>âš ï¸ ×œ× × ××¦××• ×©×™×¢×•×¨×™× ×œ×”×¦×’×” ×‘××¡××š ×–×”.</p>`;
          container.appendChild(msg);
        }

      } catch (err) {
        console.error(err);
        document.getElementById('lesson').innerText = 'âŒ ×©×’×™××” ×‘×˜×¢×™× ×ª ×”×§×•×¨×¡';
      }
    }

    loadLesson();
  </script>
</body>
</html>
